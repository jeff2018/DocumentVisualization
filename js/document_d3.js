var data={
    "links": [
        {
            "distance": 10,
            "source": 1,
            "target": 9,

        },
        {
            "distance": 10,
            "source": 4,
            "target": 9,

        },
        {
            "distance": 10,
            "source": 1,
            "target": 10,
        },
        {
            "distance": 10,
            "source": 4,
            "target": 10
        },
        {
            "distance": 10,
            "source": 5,
            "target": 10,
        },
        {
            "distance": 10,
            "source": 11,
            "target": 9,
        },
        {
            "distance": 10,
            "source": 12,
            "target": 9,
        },
        {
            "distance": 10,
            "source": 11,
            "target": 18,
        },
        {
            "distance": 10,
            "source": 2,
            "target": 19,
        },
        {
            "distance": 10,
            "source": 11,
            "target": 19,
        },
        {
            "distance": 10,
            "source": 3,
            "target": 19,
        },
        {
            "distance": 10,
            "source": 2,
            "target": 20,
        },
        {
            "distance": 10,
            "source": 11,
            "target": 20,
        },
        {
            "distance": 10,
            "source": 3,
            "target": 20,
        },
        {
            "distance": 10,
            "source": 2,
            "target": 23,
        },
        {
            "distance": 10,
            "source": 11,
            "target": 23,
        },
        {
            "distance": 10,
            "source": 3,
            "target": 23,
        },
        {
            "distance": 10,
            "source": 21,
            "target": 23,
        },
        {
            "distance": 10,
            "source": 17,
            "target": 9,
        },
        {
            "distance": 10,
            "source": 25,
            "target": 28
        },
        {
            "distance": 10,
            "source": 24,
            "target": 29,
        },
        {
            "distance": 10,
            "source": 27,
            "target": 29,
        },
        {
            "distance": 10,
            "source": 24,
            "target": 30,
        },
        {
            "distance": 10,
            "source": 27,
            "target": 30
        },
        {
            "distance": 10,
            "source": 2,
            "target": 31,
        },
        {
            "distance": 10,
            "source": 26,
            "target": 31,
        },
        {
            "distance": 10,
            "source": 24,
            "target": 32,
        },
        {
            "distance": 10,
            "source": 2,
            "target": 32,

        }
    ],
    "nodes": [
        {
            "avgDegree": 0.3002,
            "group": null,
            "id": 1,
            "name": "dbr:Visualization_(computer_graphics)",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 5"
            ],
            "value": 3,
            "words": []
        },
        {
            "avgDegree": 0.4694833333333333,
            "group": null,
            "id": 2,
            "name": "dbr:Ontology",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 3",
                "Page 4",
                "Page 5",
                "Page 6"
            ],
            "value": 6,
            "words": []
        },
        {
            "avgDegree": 0.29647999999999997,
            "group": null,
            "id": 3,
            "name": "dbr:Concept",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 3",
                "Page 4",
                "Page 5"
            ],
            "value": 5,
            "words": []
        },
        {
            "avgDegree": 0.18982500000000002,
            "group": null,
            "id": 4,
            "name": "dbr:Information_visualization",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 4",
                "Page 5"
            ],
            "value": 4,
            "words": []
        },
        {
            "avgDegree": 0.09165,
            "group": null,
            "id": 5,
            "name": "dbr:Document",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 4",
                "Page 5"
            ],
            "value": 4,
            "words": []
        },
        {
            "avgDegree": 0.1148,
            "group": null,
            "id": 6,
            "name": "dbr:Teacher",
            "pages": [
                "Page 1"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.07223333333333333,
            "group": null,
            "id": 7,
            "name": "dbr:Tool",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 5"
            ],
            "value": 3,
            "words": []
        },
        {
            "avgDegree": 0.0492,
            "group": null,
            "id": 8,
            "name": "dbr:File_manager",
            "pages": [
                "Page 1"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.04805,
            "group": null,
            "id": 9,
            "name": "dbr:Computer_science",
            "pages": [
                "Page 1",
                "Page 2",
                "Page 4",
                "Page 5"
            ],
            "value": 4,
            "words": []
        },
        {
            "avgDegree": 0.0436,
            "group": null,
            "id": 10,
            "name": "dbr:Computer_graphics",
            "pages": [
                "Page 1",
                "Page 5"
            ],
            "value": 2,
            "words": []
        },
        {
            "avgDegree": 0.511675,
            "group": null,
            "id": 11,
            "name": "dbr:Ontology_(information_science)",
            "pages": [
                "Page 2",
                "Page 3",
                "Page 4",
                "Page 5"
            ],
            "value": 4,
            "words": []
        },
        {
            "avgDegree": 0.3814,
            "group": null,
            "id": 12,
            "name": "dbr:Ontology_engineering",
            "pages": [
                "Page 2"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0763,
            "group": null,
            "id": 13,
            "name": "dbr:Information_retrieval",
            "pages": [
                "Page 2"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0893,
            "group": null,
            "id": 14,
            "name": "dbr:Parent",
            "pages": [
                "Page 3"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0893,
            "group": null,
            "id": 15,
            "name": "dbr:Child",
            "pages": [
                "Page 3"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0714,
            "group": null,
            "id": 16,
            "name": "dbr:Portable_Document_Format",
            "pages": [
                "Page 3"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.07133333333333333,
            "group": null,
            "id": 17,
            "name": "dbr:Resource",
            "pages": [
                "Page 3",
                "Page 4",
                "Page 5"
            ],
            "value": 3,
            "words": []
        },
        {
            "avgDegree": 0.0536,
            "group": null,
            "id": 18,
            "name": "dbr:Greek_language",
            "pages": [
                "Page 3"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0536,
            "group": null,
            "id": 19,
            "name": "dbr:Metaphysics",
            "pages": [
                "Page 3"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0536,
            "group": null,
            "id": 20,
            "name": "dbr:Philosophy",
            "pages": [
                "Page 3"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.15,
            "group": null,
            "id": 21,
            "name": "dbr:Paradox",
            "pages": [
                "Page 4"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.05,
            "group": null,
            "id": 22,
            "name": "dbr:Circle",
            "pages": [
                "Page 4"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.0667,
            "group": null,
            "id": 23,
            "name": "dbr:Willard_Van_Orman_Quine",
            "pages": [
                "Page 4"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.5882,
            "group": null,
            "id": 24,
            "name": "dbr:Carl_Linnaeus",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1765,
            "group": null,
            "id": 25,
            "name": "dbr:Web_search_engine",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1765,
            "group": null,
            "id": 26,
            "name": "dbr:A",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1176,
            "group": null,
            "id": 27,
            "name": "dbr:Judge",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1176,
            "group": null,
            "id": 28,
            "name": "dbr:Algorithm",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1176,
            "group": null,
            "id": 29,
            "name": "dbr:Hebrew_language",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1176,
            "group": null,
            "id": 30,
            "name": "dbr:Netherlands",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1176,
            "group": null,
            "id": 31,
            "name": "dbr:Geometry",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        },
        {
            "avgDegree": 0.1176,
            "group": null,
            "id": 32,
            "name": "dbr:Biology",
            "pages": [
                "Page 6"
            ],
            "value": 1,
            "words": []
        }
    ]
}



var pageArray = ["Page 1", "Page 2", "Page 3", "Page 4", "Page 5", "Page 6"];

var svg = d3.select("svg"),
    width = document.body.clientWidth,
    height = +svg.attr("height"),
    centerX = width * 0.5,
    centerY = height * 0.5,
    strength = 0.05;

var focusNode = null;
var documentMode = true;
var pageMode = false;
var pageWheel;
var infoBox;

var scaleRadius = d3.scaleLinear().domain([0, pageArray.length]).range([45, 95]);
var maxRadiusFocusNode = centerY * 0.75;

var color = d3.scaleSequential(d3.interpolateRainbow);
var colorPage = d3.scaleOrdinal(d3.schemeCategory10);

let pack = d3.pack()
    .size([width, height])
    .padding(1.5);


var forceCollide = d3.forceCollide(d => d.r + 2);

var simulation = d3.forceSimulation()
    .force("link",
        d3.forceLink().id(function(d) { return d.id; })
            .distance(function(d) {
                //console.log(scaleRadius(d.source.nbrPages/2 ) + scaleRadius(d.target.nbrPages/2 ))
                return (2*scaleRadius(d.source.nbrPages)) + (2*scaleRadius(d.target.nbrPages));
            })
            .strength(function(d) {return 0.75; })
    )
    .force("charge", d3.forceManyBody().strength(-100))
    .force("collide", forceCollide)
    .force('x', d3.forceX(centerX).strength(strength))
    .force('y', d3.forceY(centerY).strength(strength));


let root = d3.hierarchy({children: data.nodes})
    .sum(function (d) {
        return d.value
    });

let nodes = pack(root).leaves().map(node => {
    //console.log('node:', node.x, (node.x - centerX) * 2);
    const data = node.data;
    return {
        x: centerX + (node.x - centerX) * 3,
        y: centerY + (node.y - centerY) * 3,
        r: 0,
        radius: node.r,
        name: data.name,
        nbrPages: data.pages.length,
        pages: data.pages,
        id: data.id,
        degree: data.avgDegree
    }
});
console.log(nodes.length)
console.log(nodes)
console.log(data.links)
data.links.forEach(function(d,i){
    d.index=i
})
var forcenodedata = nodes.map(function(node, i) {
    return node;
})
var forcelinkdata = data.links.map(function(link, i) {
    return link;
})
simulation.nodes(forcenodedata).on("tick", ticked);
//var radius = d3.scaleSqrt().domain([0,1]).range([25,50]);
simulation.force("link").links(forcelinkdata);

console.log(simulation.force("link").links())



/*
var x = d3.scaleLinear()
    .domain([0, 180])
    .range([0, width])
    .clamp(true);

var slider = svg.append("g")
    .attr("class", "slider")
    .attr("transform", "translate(50,30)");

slider.append("line")
    .attr("class", "track")
    .attr("x1", x.range()[0])
    .attr("x2", x.range()[1])
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function(d) {hue(x.invert(d3.event.x)) }));

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
    .selectAll("text")
    .data(x.ticks(10))
    .enter().append("text")
    .attr("x", x)
    .attr("text-anchor", "middle")
    .text(function(d) { return d + "°"; });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);
slider.transition() // Gratuitous intro!
    .duration(750)
    .tween("hue", function() {
        var i = d3.interpolate(0, 70);
        return function(t) { hue(i(t)); };
    });

function hue(h) {
    handle.attr("cx", x(h));
    console.log(h)
    //svg.style("background-color", d3.hsl(h, 0.8, 0.8));
}*/

var step = 1,
    range = [1,32]

var slider = svg.append('g')
    .classed('slider', true)
    .attr('transform', 'translate(50, 30)');

// using clamp here to avoid slider exceeding the range limits
var xScale = d3.scaleLinear()
    .domain(range)
    .range([0, width/2])
    .clamp(true);

// array useful for step sliders
var rangeValues = d3.range(range[0], range[1], step || 1).concat(range[1]);
var xAxis = d3.axisBottom(xScale).ticks(5).tickFormat(function (d) {
    return d;
});

xScale.clamp(true);
// drag behavior initialization
var drag = d3.drag()
    .on('start.interrupt', function () {
        slider.interrupt();
    }).on('end drag', function () {
        dragged2(d3.event.x);
    });

// this is the main bar with a stroke (applied through CSS)
var track = slider.append('line').attr('class', 'track')
    .attr('x1', xScale.range()[0])
    .attr('x2', xScale.range()[1]);

// this is a bar (steelblue) that's inside the main "track" to make it look like a rect with a border
var trackInset = d3.select(slider.node().appendChild(track.node().cloneNode())).attr('class', 'track-inset');

var ticks = slider.append('g').attr('class', 'ticks').attr('transform', 'translate(0, 4)')
    .call(xAxis);

// drag handle
var handle = slider.append('circle').classed('handle', true)
    .attr('r', 8);

// this is the bar on top of above tracks with stroke = transparent and on which the drag behaviour is actually called
// try removing above 2 tracks and play around with the CSS for this track overlay, you'll see the difference
var trackOverlay = d3.select(slider.node().appendChild(track.node().cloneNode())).attr('class', 'track-overlay')
    .call(drag);

// text to display
var text = svg.append('text').attr('transform', 'translate(' + (width/2) + ', ' + height/3 + ')')
    .text('Value: 0');

// initial transition
/*slider.transition().duration(750)
    .tween("drag", function () {
        var i = d3.interpolate(0, 32);
        return function (t) {
            dragged2(xScale(i(t)));
        }
    });*/

function dragged2(value) {

    var x = xScale.invert(value), index = null, midPoint, cx, xVal;
    if(step) {
        // if step has a value, compute the midpoint based on range values and reposition the slider based on the mouse position
        for (var i = 0; i < rangeValues.length - 1; i++) {
            if (x >= rangeValues[i] && x <= rangeValues[i + 1]) {
                index = i;
                break;
            }
        }
        midPoint = (rangeValues[index] + rangeValues[index + 1]) / 2;
        if (x < midPoint) {
            cx = xScale(rangeValues[index]);
            xVal = rangeValues[index];
        } else {
            cx = xScale(rangeValues[index + 1]);
            xVal = rangeValues[index + 1];
        }
    } else {
        // if step is null or 0, return the drag value as is
        cx = xScale(x);
        xVal = x.toFixed(3);
    }
    // use xVal as drag value
    handle.attr('cx', cx);
    text.text('Value: ' + xVal);
    console.log(xVal)
    update(xVal)
}
/*var sorted = nodes.sort(function(a,b){
    return b.degree - a.degree
})*/
//console.log(sorted)
nodes.forEach(function(node,i){
    //console.log(node)
    node.rank = i+1

    node.associatedLinks = data.links.filter(function(link,j){
        //console.log(link)
        return link.source.id == node.id || link.target.id==node.id;
    })
})

nodes.forEach(function(node, i) {
    node.rank = i+1

    node.associatedNodes = []
    node.associatedLinks.forEach(function(link, j) {
        //console.log(node.name,node.id,link.source.id, link.target.id)
        if (link.source.id !== node.id) {
            node.associatedNodes.push(nodes[link.source.index])
        }
        else {
            node.associatedNodes.push(nodes[link.target.index])
        }
    })
})/*
var sorted = nodes.sort(function(a,b){
    return b.degree - a.degree
})
nodes.forEach(function(node, i) {
    node.rank = i+1
})*/
svg.append("svg:defs").selectAll('marker')
    .data(['end'])
    .enter()
    .append("svg:marker")
    .attr('id', function (d) {
        return d;
    })
    .attr('viewBox', '0 -5 10 10')
    .attr('refX', 6)
    .attr('refY',-1.5)
    .attr('markerWidth', 6)
    .attr('markerHeight', 6)
    .attr('orient', 'auto')
    .append('svg:path')
    .attr("d", "M0,-5L10,0L0,5");

var links = svg//.selectAll(".link")
    .append("g")
    .attr("class", "links")
    .selectAll("path")
    .data(simulation.force("link").links())
    .enter().append("svg:path")
    .attr("class", "link")
    .attr("stroke-width", function(d) { return 1 })
    .attr("marker-end", "url(#end)");



links.style('fill', 'none')
    .style('stroke', 'black')
    .style("stroke-width", '2px');


let nodesGraph = svg.selectAll('.node')
    .data(simulation.nodes())
    .enter().append('g')
    .attr('class', 'node')
    .on("click", async function (d) {
        await moveToCenter(d)
    })
    .call(
        d3.drag()
            .on("start", dragstarted)
            .on("drag", dragged)
            .on("end", dragended));

nodesGraph.append('circle')
    .attr('id', d => "c_" + d.index)
    .attr('r', 0)
    .attr("class", "circle")
    .style("stroke-width",0.5)
    .style("stroke","black")
    .style('fill', function (d) {
        if (d.nbrPages == 0) {
            return "lightgrey";
        } else {
            /*
            var value
            var i = parseFloat("0."+d.index)
            var rnd = Math.random()
            console.log(rnd, parseFloat(i))
            console.log(rnd+i)
            value = rnd+i
            if (value < 1){
                value = i
            }*/
            var value
            var i = parseFloat("0." + d.index)
            if (isEven(d.index)) {
                value = i
            } else {
                value = 1.0 - i
            }

            return color(value)
        }
    })
    .transition().duration(2000).ease(d3.easeElasticOut)
    .tween('circleIn', (d) => {
        let i = d3.interpolateNumber(0, scaleRadius(d.nbrPages));
        return (t) => {
            d.r = i(t);
            simulation.force('collide', forceCollide);
        }
    });


nodesGraph.append('text')
    .attr("id", function (d, i) {
        return "t_" + i
    })
    .attr("class", "nodeText")
    //.attr("dy", ".3em")
    .attr("x", function (d) {
        return 0
    })
    .attr("y", function (d) {
        return 0

    })
    .style("text-anchor", "middle")
    .text(function (d) {
        return d.name
    })
    .each(function (d, i) {
        let r = d3.select("circle[id='c_" + i + "']").attr("r")
        svg.select("#t_" + i)
            .call(wrap2, 2 * r)

    })

    .style("font-size", "15px")
/*
.each(getSize)
.style("font-size",function (d) {
    console.log(d)
    return d.scale

});*/

/*
d3.select(document).on('click', function () {

        let target = d3.event.target;
        console.log(target)
        if (target.closest(".pageArc") || target.closest(".pageText") || target.closest(".infoRect")) {
            //  console.log("as en pagearc")
            return;
        }

        if (!target.closest(".circle") && focusNode) {
            focusNode.fx = null;
            focusNode.fy = null;
            console.log(focusNode)
            simulation.alphaTarget(0.2).restart();
            d3.transition().duration(1000).ease(d3.easePolyOut)
                .tween('moveOut', function () {

                    let ir = d3.interpolateNumber(focusNode.r, scaleRadius(focusNode.nbrPages))
                    return function (t) {
                        focusNode.r = ir(t)
                        simulation.force('collide', forceCollide)
                    }
                })
                .on('end', () => {
                    let circle = d3.select("circle[id='c_" + focusNode.index + "']")
                    circle.style('fill', function (d) {
                        if (focusNode.nbrPages === 0) {
                            return "lightgrey";
                        } else {
                            var value
                            var i = parseFloat("0." + focusNode.index)
                            if (isEven(focusNode.index)) {
                                value = i
                            } else {
                                value = 1.0 - i
                            }

                            return color(value)
                        }
                    });
                    focusNode = null;
                    pageWheel = null;
                    infoBox = null;
                    simulation.alphaTarget(0);
                })
                .on('interrupt', () => {
                    simulation.alphaTarget(0);
                });

            d3.selectAll('.node')
                .filter(function (d, i) {
                    return i !== focusNode.index;
                })
                .transition().duration(2000)
                .style('opacity', 1.0);

            if (pageWheel) {
                pageWheel.remove()

            }
            if (infoBox) {
                infoBox.remove()

            }


        }
    }
)

*/
function ticked() {
    //console.log("ticking")
    var link = svg.selectAll(".link")
        .data(simulation.force("link").links(),function(d){
            //console.log(d)
            return d.index
        })

    //
    /*var links = svg//.selectAll(".link")
    .append("g")
    .attr("class", "links")
    .selectAll("path")
    .data(simulation.force("link").links())
    .enter().append("svg:path")
    .attr("class", "link")
    .attr("stroke-width", function(d) { return 1 })
    .attr("marker-end", "url(#end)");



links.style('fill', 'none')
    .style('stroke', 'black')
    .style("stroke-width", '2px');*/

    link.attr("d", function(d) {
        //console.log(d)
        var dx = d.target.x - d.source.x,
            dy = d.target.y - d.source.y,
            dr = Math.sqrt(dx * dx + dy * dy),

            offsetTargetX = (dx * d.target.r)/dr,
            offsetTargetY = (dy * d.target.r)/dr,
            offsetSourceX = (dx * d.source.r) /dr,
            offsetSourceY = (dy * d.source.r) /dr;
        //console.log(d,offsetTargetX,offsetTargetY)
        return "M" +
            d.source.x + "," +
            d.source.y + "A" +
            dr + "," + dr + " 0 0,1 " +
            (d.target.x-offsetTargetX)+ "," +
            (d.target.y-offsetTargetY);
        //return "M" + (d.source.x-offsetSourceX) + "," + (d.source.y-offsetSourceY) + "L" + (d.target.x-offsetTargetX) + "," + (d.target.y-offsetTargetY);

    });

    link.exit().remove()

    linkEnter = link.enter().append("svg:path").moveToBack()
        .attr("class", "link")
        .attr("stroke-width", function(d) { return 1 })
        .attr("marker-end", "url(#end)");



    linkEnter.style('fill', 'none')
        .style('stroke', 'black')
        .style("stroke-width", '2px')
    var node = svg.selectAll(".node")
        .data(simulation.nodes(),function(d){
             //console.log(d.index)
             return d.index
         })
    nodeEnter =node.enter().append('g')
        .attr('class', 'node')
        .on("click", async function (d) {
            await moveToCenter(d)
        })
        .call(
            d3.drag()
                .on("start", dragstarted)
                .on("drag", dragged)
                .on("end", dragended))

     nodeEnter.append("circle")
            .attr('id', d => "c_" + d.index)
            .attr('r', 0)
            .attr("class", "circle")
            .style("stroke-width",0.5)
            .style("stroke","black")
            .style('fill', function (d) {
                if (d.nbrPages == 0) {
                    return "lightgrey";
                } else {
                    var value
                    var i = parseFloat("0." + d.index)
                    if (isEven(d.index)) {
                        value = i
                    } else {
                        value = 1.0 - i
                    }

                    return color(value)
                }
            })
        nodeEnter.append('text')
        .attr("id", function (d, i) {
            return "t_" + i
        })
        .attr("class", "nodeText")
        //.attr("dy", ".3em")
        .attr("x", function (d) {
            return 0
        })
        .attr("y", function (d) {
            return 0

        })
        .style("text-anchor", "middle")
        .text(function (d) {
            return d.name
        })
        .each(function (d, i) {

            let r = d3.select("circle[id='c_" + d.index + "']").attr("r")

            svg.select("#t_" + i)
                .call(wrap2, 2 * r)

        })
            .style("font-size", "15px")

    node.exit().remove()

    //
     node.attr("transform", function (d) {
         return "translate(" + d.x + "," + d.y + ")";
     });
     node.select('circle')
         .attr('r', d => d.r);
    simulation.alphaTarget(0);
 }

 function restart(){

     var link = svg.selectAll(".link")
         .data(simulation.force("link").links(),function(d){
             //console.log(d)
             return d.index
         })


     link.exit().remove()

     var node = svg.selectAll(".node")
         .data(simulation.nodes(),function(d){
             //console.log(d.index)
             return d.index
         })
     node.exit().remove()
    /*node= node.enter().append('g')
         .attr('class', 'node')
         .on("click", async function (d) {
             await moveToCenter(d)
         })
         .call(
             d3.drag()
                 .on("start", dragstarted)
                 .on("drag", dragged)
                 .on("end", dragended));

     node.append("circle")
         .attr('id', d => "c_" + d.index)
         .attr('r', 0)
         .attr("class", "circle")
         .style("stroke-width",0.5)
         .style("stroke","black")
         .style('fill', function (d) {
             if (d.nbrPages == 0) {
                 return "lightgrey";
             } else {
                 var value
                 var i = parseFloat("0." + d.index)
                 if (isEven(d.index)) {
                     value = i
                 } else {
                     value = 1.0 - i
                 }

                 return color(value)
             }
         }).merge(node)
/*
     node.append('text')
         .attr("id", function (d, i) {
             return "t_" + i
         })
         .attr("class", "nodeText")
         //.attr("dy", ".3em")
         .attr("x", function (d) {
             return 0
         })
         .attr("y", function (d) {
             return 0

         })
         .style("text-anchor", "middle")
         .text(function (d) {
             return d.name
         })
         .each(function (d, i) {
             let r = d3.select("circle[id='c_" + i + "']").attr("r")
             svg.select("#t_" + i)
                 .call(wrap2, 2 * r)

         })*/

    /*     node.data(simulation.nodes(),function(d){
             console.log(d.index)
             return d.index
         })

     node
         .enter().append('g')
         .attr('class', 'node')
         .on("click", async function (d) {
             await moveToCenter(d)
         })
         .call(
             d3.drag()
                 .on("start", dragstarted)
                 .on("drag", dragged)
                 .on("end", dragended));

     node.append("circle")
         .attr('id', d => "c_" + d.index)
         .attr('r', 0)
         .attr("class", "circle")
         .style("stroke-width",0.5)
         .style("stroke","black")
         .style('fill', function (d) {
             if (d.nbrPages == 0) {
                 return "lightgrey";
             } else {
                 var value
                 var i = parseFloat("0." + d.index)
                 if (isEven(d.index)) {
                     value = i
                 } else {
                     value = 1.0 - i
                 }

                 return color(value)
             }
         })
     node.append('text')
         .attr("id", function (d, i) {
             return "t_" + i
         })
         .attr("class", "nodeText")
         //.attr("dy", ".3em")
         .attr("x", function (d) {
             return 0
         })
         .attr("y", function (d) {
             return 0

         })
         .style("text-anchor", "middle")
         .text(function (d) {
             return d.name
         })
         .each(function (d, i) {
             let r = d3.select("circle[id='c_" + i + "']").attr("r")
             svg.select("#t_" + i)
                 .call(wrap2, 2 * r)

         })

         .style("font-size", "15px")*/
    simulation.nodes(simulation.nodes());
    simulation.alpha(2).restart();

}

function getSize(d) {
    var bbox = this.getBBox(),
        cbbox = this.parentNode.getBBox(),

        scale = Math.max(cbbox.width / bbox.width, cbbox.height / bbox.height)
    console.log(bbox, cbbox)
    d.scale = scale
}

async function moveToCenter(currentNode) {

    d3.event.stopImmediatePropagation();
    console.log('currentNode', currentNode)

    d3.selectAll('.node')
        .transition().duration(100)
        .style('opacity', 1.0);

    if (currentNode === focusNode) {
        console.log("True as equal")
        return;
    }

    let lastNode = focusNode;
    focusNode = currentNode;


    pageWheel = d3.select(".pageWheel")
    if (pageWheel) {
        pageWheel.remove()
    }
    if (infoBox) {
        infoBox.remove()
    }

    if (lastNode) {
        console.log("lastNode", lastNode)

        lastNode.fx = null;
        lastNode.fy = null;
        node.filter(function (d, i) {
            return i === lastNode.index
        })
            .transition().duration(2000)
            .tween('circleOut', await function () {
                console.log("lastnode.r", lastNode.r)
                console.log("lastnode.radius", lastNode.radius)
                console.log("nbrpages", lastNode.nbrPages)
                console.log("scale radius", scaleRadius(lastNode.nbrPages))

                let irl = d3.interpolateNumber(lastNode.r, scaleRadius(lastNode.nbrPages))
                return function (t) {
                    lastNode.r = irl(t)
                }
            })
            .on('interrupt', () => {
                lastNode.r = scaleRadius(lastNode.nbrPages);
                let circle = d3.select("circle[id='c_" + lastNode.index + "']")
                circle.style('fill', function (d) {
                    if (lastNode.nbrPages === 0) {
                        return "lightgrey";
                    } else {
                        var value
                        var i = parseFloat("0." + lastNode.index)
                        if (isEven(lastNode.index)) {
                            value = i
                        } else {
                            value = 1.0 - i
                        }

                        return color(value)
                    }
                })

            });
    }

    simulation.alphaTarget(0.2).restart()

    d3.transition().duration(2000)
        .tween('moveIn', function () {
            console.log('tweenMoveIn', currentNode)
            let ix = d3.interpolateNumber(currentNode.x, centerX);
            let iy = d3.interpolateNumber(currentNode.y, centerY);
            let ir = d3.interpolateNumber(currentNode.r, maxRadiusFocusNode);

            return function (t) {
                currentNode.fx = ix(t);
                currentNode.fy = iy(t);
                currentNode.r = ir(t);
                simulation.force('collide', forceCollide);
            }


        })
        .on('end', () => {
            drawArc(currentNode)


        })
        .on('interrupt', () => {
            console.log('move interrupt', currentNode);
            currentNode.fx = null;
            currentNode.fy = null;
            simulation.alphaTarget(0);
        });
    d3.selectAll('.node')
        .filter(function (d, i) {
            return i !== currentNode.index;
        })
        .transition().duration(2000)
        .style('opacity', 0.5);
    //drawArc(currentNode)
    /*
    d3.selectAll('.node')
        .filter(function(d,i) { return i === currentNode.index; })
        .transition().duration(1000)
        .tween('transform', function(d) {
            var that = d3.select(this);

            return function (t) {
                that.attr('transform', function (d) {
                    var k = "translate(" + width / 2 + "," + height / 2 +")";
                    return k
                })
                simulation.nodes(data)
            }
        })*/
    /*
    d3.selectAll('.node')
        .filter(function(d,i){
            return i === currentNode.index
        })
        .transition().duration(1000)
        .attrTween('transform', function(){
            var k = "translate(" + width / 2 + "," + height / 2 +")";
            return k
        })

*/


    /*
    var clickedNode = d3.select("#n_"+d.index)
    console.log(clickedNode)
    d3.selectAll('.node').on("tick",ticked);
    simulation
        .nodes(data)
        .on("tick", ticked);

    clickedNode.transition().attr('transform',function(d){
        d3.selectAll('.node').on("tick",ticked);
        simulation
            .nodes(data)
            .on("tick", ticked);

        var k = "translate(" + width / 2 + "," + height / 2 +")";
        return k
    })*/
}


async function drawArc(currentNode) {
    //console.log(currentNode.fx, currentNode.fy, currentNode.r)

    function endall(transition, callback) {
        if (typeof callback !== "function") throw new Error("Wrong callback in endall");
        if (transition.size() === 0) {
            callback()
        }
        var n = 0;
        transition
            .each(function () {
                ++n;
            })
            .on("end", function () {
                if (!--n) callback.apply(this, arguments);
            });
    }

    function computeTextRotation(d) {

        var angle = (d.startAngle + d.endAngle) / Math.PI * 90;

        // Avoid upside-down labels; labels as rims
        return (angle < 120 || angle > 270) ? angle : angle + 180;
        //return (angle < 180) ? angle - 90 : angle + 90;  // labels as spokes
    }

    var increase = 50
    var arc_IR = parseInt(currentNode.r + increase);
    var arc_OR = parseInt(currentNode.r);


    pageWheel = svg
        .append('g')
        .attr("class", "pageWheel")
        .attr('transform', 'translate(' + currentNode.fx + ',' + currentNode.fy + ')');


    var pie = d3.pie()
        .value(1)
        .sort(null);

    var arc = d3.arc()
        .innerRadius(arc_IR)
        .outerRadius(arc_OR);


    var path = pageWheel.selectAll(".pageArc")
        .data(pie(pageArray))
        .enter()

    path.append("path")
        .attr("d", arc)
        .attr("class", "pageArc")
        .attr("value_id", function (d, i) {
            return i + 1
        })
        .attr("id", function (d, i) {
            return "pageArc_" + parseInt(i + 1)
        })
        .attr("value_fill", function (d, i) {
            // console.log(currentNode.pages)
            if (currentNode.pages.includes(d.data)) {
                return colorPage(i);
            } else {
                return "lightgrey"
            }

        })
        .attr("fill", function (d, i) {
            //console.log(currentNode.pages)
            if (currentNode.pages.includes(d.data)) {
                return colorPage(i);
            } else {
                return "lightgrey"
            }

        })
        .style("stroke", "White")
        .style("stroke-widht", "2")
        .transition()
        .attrTween('d', function (d) {
            var i = d3.interpolate(d.startAngle + 0.1, d.endAngle);
            let ir = d3.interpolateNumber(currentNode.r, currentNode.r + increase);
            return function (t) {
                currentNode.r = ir(t);
                simulation.force('collide', forceCollide);
                d.endAngle = i(t);
                return arc(d);
            }
        })
        .call(endall, () => {
            var text = path.append("g")
                .append("text")
                .attr("dy", ".3em")
                .attr("class", "pageText")
                .attr("transform", function (d) {
                    // console.log(d)
                    return "translate(" + arc.centroid(d) + ")rotate(" + computeTextRotation(d) + ')';
                })
                .attr("text-anchor", "middle")
                .text(function (d, i) {
                    return d.data
                }).style("font-size", "20px")

            //console.log(d3.select(".pageArc"))
            d3.selectAll(".pageArc")
                .on("mouseover", pieceMouseOver)
                .on("mouseout", pieceMouseOut)
                .on("click", function (d) {
                    toggleColor(d)
                    updatePageSelection(d)
                    //console.log(currentNode.pages)

                })


        })
    await drawInfoBox(currentNode)

    function updatePageSelection(d) {
        var pages = currentNode.pages
        //console.log(pages)
        var pieceInfo = d.data
        //console.log(pieceInfo)
        if (pages.includes(pieceInfo)) {
            currentNode.pages = arrayRemove(pages, pieceInfo)
        } else {
            currentNode.pages.push(pieceInfo)
        }
        currentNode.pages.sort()
        currentNode.nbrPages = currentNode.pages.length
        //console.log(currentNode.pages)


    }


}

async function drawInfoBox(currentNode) {

    var results = await querySPARQL(currentNode);
    console.log(results)

    var posX = currentNode.fx - ((maxRadiusFocusNode + (maxRadiusFocusNode / 2.5)) / 2)
    var posY = currentNode.fy - ((maxRadiusFocusNode + (maxRadiusFocusNode / 2.5)) / 2)
    var boxWidth = maxRadiusFocusNode + (maxRadiusFocusNode / 2.5)
    /*
    var div = d3.select("#scroll")
        .style("height",boxWidth+"px")
        .style("width",boxWidth+"px")
        .style("top",0 +"px")
        .style("left",0 +"px")

        .text(results[0][0].abstract.value)

    var infobox = svg.append("g")
        .attr("class","infobox")
        .attr('transform', 'translate(' + posX + ',' + posY + ')');

    var foreign = infobox.append("foreignObject")
        .attr("width",boxWidth)
        .attr("height",boxWidth)
        .append(div)
     .style("overflow-y","scroll")
        .text(results[0][0].abstract.value)
        .style("font-size", "14px")
*/
    console.log("Boxwidth",boxWidth*0.32)
    infoBox = svg.selectAll("infobox")
        .data(results)
        .enter()
        .append("g")
        .attr('transform', 'translate(' + posX + ',' + posY + ')');

    /*var fo= infoBox.append("foreignObject")
        .attr('class',"container")
        .attr("height", boxWidth)
        .attr("width", boxWidth)

    var div = fo.append("div")
        .attr('class',"content")
        .attr("id","viz")
        .attr("height", boxWidth)
        .attr("width", boxWidth)
*/
    var infoRect = infoBox.append("rect")

        .attr("class","infoRect")
        .attr("height", boxWidth)
        .attr("width", boxWidth)
        .attr("fill", "white")
        .style("opacity", 0.85)
        .on("mouseover",function(d){
            d3.select(this)

            .style("stroke", "Black")
            .style("stroke-width", "2")
        })
        .on("mouseout",function(d){
            d3.select(this)

                .style("stroke", "White")
                .style("stroke-width", "2")
        })
        .on("click",function(d){
            var linkWiki = d[0].wikiLink.value
            console.log(d[0].wikiLink.value)
            window.open(linkWiki)
        })

    var infoText = infoBox.append("text")
        .attr("class", "infoText")
        .attr("text-anchor", "start")
        .attr("x", 2)
        .attr("y", boxWidth *0.32)
        .text(function (d) {
            var dbabstract = d[0].abstract.value
            ///console.log(d[0][0].abstract.value)
            //console.log("abstract ",d[0][0].abstract.value)
            return dbabstract
        })
        .style("font-size", "14px")
        .call(wrap, maxRadiusFocusNode + (maxRadiusFocusNode / 2.5))

    var infoTitle = infoBox.append("text")
        .attr("class", "infoTitle")
        .attr("text-anchor", "start")
        .attr("x", 30)
        .attr("y", 65)
        .text(function(d){
            var dblabel = d[0].label.value
            return dblabel
        })
        .style("font-size", "22px")
        .style("font-weight","bold")
        .style("text-decoration","underline")

    var infoImage = infoBox.append('image')
        .attr("class", "infoImage")

        .attr('xlink:href',function(d){
            var dbthumbnail = d[0].image
            if(dbthumbnail){
                return dbthumbnail.value
            }
        })
        .attr('width', 155)
        .attr('height', 155)
        .attr("x", boxWidth-202)
        .attr("y", 0)







}

function arrayRemove(arr, value) {

    return arr.filter(function (ele) {
        return ele != value;
    });

}


function dragstarted(d) {
    if (focusNode === null) {
        if (!d3.event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
    }
}

function dragged(d) {
    if (focusNode === null) {
        d.fx = d3.event.x;
        d.fy = d3.event.y;
    }

}

function dragended(d) {
    if (focusNode === null) {
        if (!d3.event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
    }
}

function toggleColor(d) {
    //console.log("togglecolor",d)
    var pieceSelect = "#" + "pageArc_" + parseInt(d.index + 1)
    var currentColor = d3.select(pieceSelect).attr("value_fill")

    currentColor = currentColor == "lightgrey" ? colorPage(d.index) : "lightgrey";

    d3.select(pieceSelect).attr("value_fill", currentColor);
    d3.select(pieceSelect).style("fill", currentColor);

}




var pieceMouseOver = function () {

    var pieceObject = d3.select(this)
    var valueID = pieceObject.attr("value_id");

    var pieceSelect = "#" + "pageArc_" + valueID
    var selection = d3.selectAll(pieceSelect)
    selection.style("stroke", "Black")
    selection.style("stroke-width", "1")
}

var pieceMouseOut = function () {
    var pieceObject = d3.select(this)

    var valueID = pieceObject.attr("value_id");

    var pieceSelect = "#pageArc_" + valueID
    var selection = d3.selectAll(pieceSelect)

    selection.style("stroke", "White")
    selection.style("stroke-width", "1")
}

function wrap2(text, width) {
    text.each(function () {
        var text = d3.select(this)
        var joinOperator = " "
        if (text.text().includes("-")) {
            joinOperator = "-"
        }
        if (text.text().includes("_")) {
            joinOperator = "_"
        }
        var words = text.text().split(/[ _-]+/).reverse(), ///[ _]+/ /\s+/
            word,
            counter = 0,
            line = [],
            lineNumber = 0,
            lineHeight = 1.2, // ems
            startBox = (lineHeight / 2) / 2,
            x = text.attr("x"),
            y = text.attr("y"),
            dy = text.attr("dy") ? text.attr("dy") : 0,
            totalLines = words.length,
            start = -(lineHeight / 2) * (totalLines - 1),
            resultingLines = [],
            adjustment = 0;

        if (totalLines > 1) {
            if (!isEven(totalLines)) {
                start = startBox - (lineHeight / 2) * (totalLines - 1);
            } else {
                start = startBox - (lineHeight / 2) - (2 / totalLines);
            }

        } else {
            start = startBox
        }

        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", start + "em").attr("id", "start").attr("value", start);

        /*console.log(tspan)
        console.log(words)
        console.log(totalLines,lineHeight,lineHeight*totalLines)*/


        while (word = words.pop()) {
            //console.log(word)

            line.push(word);
            //console.log(line)
            tspan.text(line.join(joinOperator));
            //console.log(line.join(joinOperator))
            //console.log(tspan.node().getComputedTextLength() > width)
            if (tspan.node().getComputedTextLength() > width) {
                var last = line.pop();
                //console.log(last)
                resultingLines.push(last)
                tspan.text(line.join(joinOperator));
                line = [word];
                //console.log(line,lineNumber,lineHeight,dy,resultingLines.length)
                var modifier;


                if (totalLines > 1) {
                    if (words.length !== 0) {
                        modifier = ++lineNumber * lineHeight + (start * (totalLines - 1))

                    } else {
                        modifier = ++lineNumber * lineHeight + (start * (resultingLines.length - 1))
                        //console.log(resultingLines.length < totalLines)
                        if (resultingLines.length < totalLines) {
                            var old = text.selectAll("tspan").attr("value")
                            //console.log(old)
                            adjustment = lineHeight / 2
                            text.selectAll("tspan").attr("dy", parseFloat(old) + adjustment + "em").attr("value", parseFloat(old) + adjustment)
                        }

                    }
                } else {
                    modifier = 0
                }
                counter = counter + 1

                tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", modifier + parseFloat(adjustment) + "em").attr("id", "if").attr("value", modifier).text(word);
                //console.log(lineNumber)
            } else {
                resultingLines.shift()
                resultingLines.push(line.join(" "))
                if (words.length === 0 && totalLines > 1) {
                    var old = text.selectAll("tspan").attr("value")
                    //console.log(old)
                    adjustment = lineHeight / 2
                    text.selectAll("tspan").attr("dy", parseFloat(old) + adjustment + "em").attr("value", parseFloat(old) + adjustment)
                }
            }

        }


    });


}


async function querySPARQL(currentNode) {
    var url = "http://dbpedia.org/sparql";
    var resource = currentNode.name
    var abstract = "?abstract"
    var wikiLink = "?wikiLink"
    var label = "?label"
    var dbPage = "?page"
    var image = "?image"
    var finalResource;

    var resp = []
    const escapeRegExp = (string) => {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')
    }
    finalResource = escapeRegExp(resource)

    //console.log(finalResource)

    var query = [
        "PREFIX rdfs: <http://www.w3.org/2000/01/rdf-schema#>",
        "PREFIX type: <http://dbpedia.org/class/yago/>",
        "PREFIX prop: <http://dbpedia.org/property/>",
        "SELECT" + abstract + ", " + label + ", " + wikiLink + ", " + dbPage+ ", " + image,
        "WHERE {",
        "{",
        " " + finalResource + " dbo:wikiPageRedirects " + dbPage + ".",
        " " + wikiLink + " foaf:primaryTopic " + dbPage + ".",
        "Optional{ " + dbPage + " dbo:thumbnail " + image + "}" + ".",
        "Optional{ " + dbPage + " dbo:abstract " + abstract + "}" + ".",
        " " + dbPage + " rdfs:label " + label + ".",
        "FILTER langMatches(lang(" + label + "),'en')" + ".",
        "FILTER langMatches(lang(" + abstract + "),'en')",
        "}",
        "UNION {",
        " " + wikiLink + " foaf:primaryTopic " + finalResource + ".",
        "Optional{ " + finalResource + " dbo:thumbnail " + image + "}" + ".",
        "Optional{ " + finalResource + " dbo:abstract " + abstract + "}" + ".",
        " " + finalResource + " rdfs:label " + label + ".",
        "FILTER langMatches(lang(" + label + "),'en')" + ".",
        "FILTER langMatches(lang(" + abstract + "),'en')",
        "}",
        "}",
        "Limit 100"
    ].join(" ");


    //console.log("this query: [" + query + "]");

    var queryUrl = url + "?query=" + encodeURIComponent(query) + "&format=json";
    //console.log(queryUrl)

    await $.ajax({
        dataType: "jsonp",
        url: queryUrl,
        success: function (data) {
            //console.log(data);
            var bindings = data.results.bindings;
            resp.push(bindings)

        }
    });
    return resp
}

d3.selection.prototype.moveToFront = function () {
    return this.each(function () {
        this.parentNode.appendChild(this);
    })
};

d3.selection.prototype.moveToBack = function () {
    return this.each(function () {
        var firstChild = this.parentNode.firstChild;
        if (firstChild) {
            this.parentNode.insertBefore(this, firstChild);
        }
    });
};

function isEven(n) {
    return n % 2 == 0;
}

function wrap(text, width) {
    text.each(function () {
        var text = d3.select(this),
            words = text.text().split(/[ _]+/).reverse(), ///[ _]+/ /\s+/
            word,
            counter = 0,
            line = [],
            lineNumber = 0,
            lineHeight = 1.2, // ems
            x = text.attr("x"),
            y = text.attr("y"),
            dy = text.attr("dy") ? text.attr("dy") : 0,
            timeToBreak = false;
        tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em")
        while (word = words.pop()) {
            if(lineNumber ===20){
                timeToBreak = true

            }
            //console.log(word)
            counter = counter + 1
            //console.log(counter)
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > width) {
                line.pop();
                tspan.text(line.join(" "));

                line = [word];
                //console.log(lineNumber)

                //console.log(line)
                if(timeToBreak===true){
                    tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text("...");
                    break;
                }

                tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);

            }

        }
    });
}

$('#switch_modus').change(function(d){

    if(!this.checked){
        documentMode = true
        pageMode = false
        d3.selectAll('circle')
            .style('fill', function (d) {
                if (d.nbrPages == 0) {
                    return "lightgrey";
                } else {
                    /*
                    var value
                    var i = parseFloat("0."+d.index)
                    var rnd = Math.random()
                    console.log(rnd, parseFloat(i))
                    console.log(rnd+i)
                    value = rnd+i
                    if (value < 1){
                        value = i
                    }*/
                    var value
                    var i = parseFloat("0." + d.index)
                    if (isEven(d.index)) {
                        value = i
                    } else {
                        value = 1.0 - i
                    }

                    return color(value)
                }
            })
    }else{
        pageMode = true
        documentMode = false
        d3.selectAll('circle') //<-- or slap a class name on your circles and use that
            .style('fill', 'blue');
    }
})
/*
var x = d3.scaleLinear()
    .domain([1,nodes.length])
    .range([0,500])
    .clamp(true)

var xAxis = d3.axisBottom()
    .scale(x)
    .ticks(5)

var brush = d3.brushX()
    .extent([[1,1],[500,50]])
    .on("brush",brushed)

var slider = svg.append("g")
    .attr("transform","translate(50,0)")

slider.append("g")
    .attr("class","x axis")
    .attr("transform","translate(0,30)")
    .call(xAxis)
    .select(".domain")
    .select(function() {
        console.log(this.parentNode.appendChild(this.cloneNode(true)))
        return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "halo");

slider.append("g")
    .attr("class", "slider")
    .call(brush)

var handle = slider.append("circle")
    .attr("class", "handle")
    .attr("transform", "translate(0,30)")
    .attr("r", 9);

function brushed() {
    var value = brush.extent()[0];

    if (d3.event.sourceEvent) { // not a programmatic event
        value = x.invert(d3.mouse(this)[0]);
        brush.extent([value, value]);
    }

    handle.attr("cx", x(value));
    console.log(value,x(value))
}
*/
/*
var x = d3.scaleLinear()
    .domain([1,nodes.length])
    .range([0,width/2])
    .clamp(true)

var slider = svg.append("g")
    .attr("transform","translate(50,30)")

slider.append("line")
    .attr("class", "track")
    .attr("x1", x.range()[0])
    .attr("x2", x.range()[1])
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-inset")
    .select(function() { return this.parentNode.appendChild(this.cloneNode(true)); })
    .attr("class", "track-overlay")
    .call(d3.drag()
        .on("start.interrupt", function() { slider.interrupt(); })
        .on("start drag", function() {
            currentValue = d3.event.x;
            update(x.invert(currentValue));
        })
    );

slider.insert("g", ".track-overlay")
    .attr("class", "ticks")
    .attr("transform", "translate(0," + 18 + ")")
    .selectAll("text")
    .data(x.ticks(5))
    .enter()
    .append("text")
    .attr("x", x)
    .attr("y", 10)
    .attr("text-anchor", "middle")
    .text(function(d) { return d; });

var handle = slider.insert("circle", ".track-overlay")
    .attr("class", "handle")
    .attr("r", 9);
*/
function update(h) {
    // update position and text of label according to slider scale
    //handle.attr("cx", x(h));
   // console.log(h,x(h),)
    nodes.forEach(function(d,i){
        var idx =-1;
        //console.log("d ",d.name)
        simulation.nodes().forEach(function(node,j){
            //console.log("node ",node)
            if(node.index===d.index){
                idx=j
            }
            //console.log("d ",idx,d.name, simulation.nodes().length)

        });
        //console.log("--------------")

        if(d.rank <= h){
            //console.log("if as true fir ", d.name,h,d.rank)


            if(idx === -1){
                //console.log("ech well adden ",d.name)
                simulation.nodes().push(d)
                d.associatedNodes.forEach(function(node,i){
                    var nIdx = -1;
                    simulation.nodes().forEach(function(fnode,j){
                        if(node.index===fnode.index){
                            d.associatedLinks.forEach(function(link,k){
                                if(link.target.id ===fnode.id || link.source.id===fnode.id){
                                    simulation.force("link").links().push(link)
                                    //console.log("alles okay  ",d.name)

                                }
                            })
                        }
                    })
                })
            }
            else{

            }
        }
        else{
            if(idx!==-1){
                simulation.nodes()[idx].associatedLinks.forEach(function(link,i){
                    var lIdx =-1;
                    simulation.force("link").links().forEach(function(llink,j){
                        if(llink.index===link.index){
                            lIdx=j;
                        }
                    })
                    simulation.force("link").links().splice(lIdx,1)

                })
                simulation.nodes().splice(idx,1)
            }
        }
    })

simulation.alphaTarget(0.5).restart()
//restart()
}